
#### 建立与区块链代理的连接connectChainProxy
默认区块链节点：最近连接成功的链节点
区块链代理节点列表：链节点初始化列表+可配置调整（过滤重复）
```mermaid
graph TD
建立与区块链代理的连接--> 尝试与默认区块链节点进行连接 --> 是否连接成功
是否连接成功 -- 成功 -->返回链节点连接对象chainApi
是否连接成功 -- 失败 --> 尝试与备用区块链代理节点进行连接 --> 是否再次连接成功
是否再次连接成功 -- 成功 --> 最快连接成功的区块链代理节点,设置为默认区块链节点
是否再次连接成功 -- 失败 --> 返回失败
```

#### 建立与节点的连接connectDcNode
默认DC节点：最近连接成功的DC节点（有效期）
DC节点列表：链节点获取的DC节点列表+可配置调整（过滤重复）
```mermaid
graph TD
建立与DC节点的连接--> 判断是否有默认节点 -- 已有 --> 尝试与默认节点进行连接 --> 是否连接成功
判断是否有默认节点 -- 没有 --> 链上获取节点列表
是否连接成功 -- 成功 --> 返回节点连接对象
是否连接成功 -- 失败 --> 链上获取节点列表 --> 再遍历建立连接 --> 判断是否能连接成功
判断是否能连接成功 -- 成功 --> 最快连接成功的DC节点,设置为默认DC节点-同时设置默认节点的冻结时间,默认节点失效就不再优先连接
判断是否能连接成功 -- 失败 --> 返回失败
```

#### 节点连接状态（用本身的状态判断）
```mermaid
graph TD
30s定时任务 --> 获取节点连接状态 --> 是否连接中
是否连接中 -- 已连接 --> 30s定时任务
是否连接中 -- 断开 --> 1s定时任务 --> 是否连接
是否连接 -- 已连接 --> 30s定时任务
是否连接 -- 断开 --> 1s定时任务
```



#### 获取token
```mermaid
graph TD
判断私钥是否已存在 -- 不存在 --> 获取token
判断私钥是否有效 -- 失效 --> 清除token --> 获取token
判断私钥是否已存在 -- 存在 --> 判断私钥是否有效
判断私钥是否有效 -- 有效 --> 返回token
```

#### 获取节点token（默认节点+用户节点）
```mermaid
graph TD
判断是否已经存在节点client -- 不存在 --> 结束
判断是否已经存在节点client -- 存在 --> 判断节点client是否连接
判断节点client是否连接 -- 没连接 --> 连接节点client
连接节点client -- 成功 --> 判断token是否存在
连接节点client -- 失败 --> 结束
判断token是否存在 -- 不存在 --> 结束
判断token是否存在 -- 存在 --> 验证token 
连接节点client -- 失败 --> 结束
判断节点client是否连接 -- 已连接 --> 判断token是否存在
验证token -- 错误 --> 错误invalid-token --> 重新刷新token
重新刷新token -- 成功 --> 返回token
重新刷新token -- 失败 --> 结束
验证token -- 错误 --> 其他错误 --> 重新连接节点client
重新连接节点client -- 成功 --> 获取token
获取token -- 成功 --> 返回token
获取token -- 失败 --> 结束
重新连接节点client -- 失败 --> 结束
验证token -- 成功 --> 返回token
```

#### 开启定时验证token线程
```mermaid
graph TD
开启定时验证token线程--> token验证任务是否已经开启 
token验证任务是否已经开启 --> 已经开启,结束
token验证任务是否已经开启 --> 未开启 --> 启动30s一次心跳维持连接 --> 每次心跳都进行判断
每次心跳都进行判断 --> 上下文结束,结束所有循环
每次心跳都进行判断 --> 心跳count+1 --> 判断是否已经存在节点client
判断是否已经存在节点client -- 不存在 --> 结束这次循环
判断是否已经存在节点client -- 存在 --> 获取节点token --> 获取用户节点token --> 结束这次循环
```


// 删除过期数据
// 启动数据库空间监控,当数据库空间不足时，自动分配20M

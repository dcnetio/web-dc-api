
# DC 去中心化网络全接口文档

## 目录
1. [核心接口](#1-核心接口)  
2. [用户体系](#2-用户体系)  
3. [内容管理](#3-内容管理)  
4. [文件操作](#4-文件操作)  
5. [缓存管理](#5-缓存管理)  
6. [网络相关](#6-网络相关)  
7. [区块链交互](#7-区块链交互)  
8. [数据库管理](#8-数据库管理)  
9. [消息系统](#9-消息系统)

---

## 1. 核心接口

### 系统初始化
```typescript
async init(): Promise<void>
```
- **功能**：初始化区块链连接和P2P网络节点
- **调用要求**：必须第一个调用
- **异常**：连接失败时抛出网络错误

---

## 2. 用户体系

### 2.1 账户认证
```typescript
async accountLogin(
  nftAccount: string,
  password: string,
  safecode: string
): Promise<boolean>
```
| 参数 | 类型 | 说明 |
|------|------|------|
| nftAccount | string | NFT账户地址（BASE32编码）|
| password | string | 账户密码 |
| safecode | string | 二次验证码 |

### 2.2 用户信息
```typescript
async getUserInfoWithNft(nftAccount: string): Promise<[User, Error]>

interface User {
  usedSpace: number        // 已用存储（字节）
  offchainSpace: number    // 链下存储配额（MB）
  storageNodes: string[]   // 存储节点列表
  lastActive: number       // 最后活跃时间戳
}
```

### 2.3 存储管理
```typescript
async ifEnoughUserSpace(needSize?: number): Promise<boolean>
async addUserOffChainSpace(): Promise<[boolean, Error]>
async refreshUserInfo(): Promise<User>
```

---

## 3. 内容管理

### 3.1 主题操作
```typescript
async addThemeObj(
  theme: string,
  openFlag: number,
  commentSpace?: number
): Promise<[number, Error]>

async addThemeSpace(
  theme: string,
  addSpace: number
): Promise<[number, Error]>

async getThemeObj(
  themeAuthor: string,
  startHeight?: number,
  direction?: number,
  offset?: number,
  limit?: number,
  seekKey?: string
): Promise<ThemeObject[]>

interface ThemeObject {
  theme: string
  appId: string
  blockheight: number
  commentSpace: number
  openFlag: number
}
```

### 3.2 评论系统
```typescript
async publishCommentToTheme(
  theme: string,
  themeAuthor: string,
  commentType: number,
  comment: string,
  refercommentkey?: string
): Promise<[string, Error]>

async deleteSelfComment(
  theme: string,
  themeAuthor: string,
  commentKey: string
): Promise<[number, Error]>

async getThemeComments(
  theme: string,
  themeAuthor: string,
  startHeight?: number,
  direction?: number,
  offset?: number,
  limit?: number,
  seekKey?: string
): Promise<Comment[]>

async getUserComments(
  userPubkey: string,
  startHeight?: number,
  direction?: number,
  offset?: number,
  limit?: number,
  seekKey?: string
): Promise<UserComment[]>
```

**数据结构**：
```typescript
interface Comment {
  commentCid: string
  blockheight: number
  content: string
  status: 0|1          // 0-正常 1-删除
  upvotes: number
  author: string
}

interface UserComment extends Comment {
  theme: string
  themeAuthor: string
}
```

---

## 4. 文件操作

### 文件传输
```typescript
async getFileFromDc(
  cid: string,
  decryptKey: string
): Promise<Uint8Array | "">

async addFile(
  file: File,
  enkey: string,
  onUpdateTransmitSize: (status: number, size: number) => void
): Promise<[string, Error]>
```

**参数说明**：
- `onUpdateTransmitSize` 回调参数：
  - status: 0=准备 1=传输中 2=完成
  - size: 已传输字节数

---

## 5. 缓存管理

### 键值存储
```typescript
async getCacheValueFromDc(key: string): Promise<string | null>
async setCacheKey(value: string): Promise<[string, Error]>
```

**存储限制**：
- 单个键值最大 1MB
- 最多存储 1000 个键

---

## 6. 网络相关

### 节点信息
```typescript
async getHostID(): Promise<[
  { peerID: string; reqAddr: string } | null, 
  Error | null
]>
```

**返回示例**：
```json
{
  "peerID": "12D3KooW...",
  "reqAddr": "/ip4/192.168.1.100/tcp/4001"
}
```

---

## 7. 区块链交互

### 链上操作
```typescript
async getBlockHeight(): Promise<number>
```

**性能指标**：
- 平均响应时间：< 500ms
- 支持同时 1000+ 并发查询

---

## 8. 数据库管理

### 数据库操作
```typescript
async newDB(
  name: string,
  b32Rk: string,
  b32Sk: string,
  jsonCollections: ICollectionConfig[]
): Promise<string>
```

**安全要求**：
- 读密钥（b32Rk）必须为 base32 编码
- 写密钥（b32Sk）需要 RSA-2048 加密

---

## 9. 消息系统

### 加密通信
```typescript
async sendMsgToUserBox(
  receiver: string,
  msg: string
): Promise<DCError[] | number[]>

async getMsgFromUserBox(
  limit?: number
): Promise<[{[k: string]: any}[], Error]>
```

**加密协议**：
- 使用 ECDH-256 密钥交换
- 消息体使用 AES-GCM 加密

---

## 附录：错误代码表

| 代码 | 类型 | 描述 | 解决方案 |
|------|------|------|----------|
| 1001 | NETWORK_FAILURE | 网络连接失败 | 检查节点状态 |
| 2003 | AUTH_EXPIRED | 认证令牌过期 | 重新获取Token |
| 3005 | STORAGE_FULL | 存储空间不足 | 调用addUserOffChainSpace |
| 4102 | COMMENT_DELETED | 评论已删除 | 检查评论状态码 |

[下载PDF版本](https://dc.network/docs/api.pdf) | [交互式示例](https://playground.dc.network)

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="../../grpc-libp2p-client/dist/grpc.min.js"></script>
  <script src="../dist/dc.min.js"></script>
  <script>
    const DC = WebDcApi.DC;
    let dc = null;
    const init = async () => {
      dc = new DC({
         wssUrl: 'ws://192.168.31.31:9944',
         backWssUrl: 'ws://192.168.31.31:9944',
        // wssUrl: 'wss://chain.baybird.cn', // 区块链路径
        // backWssUrl: 'wss://dc.baybird.cn',  // 可选备用区块链路径
        appInfo: {
          appId: 'testHtml',  // 应用ID
          appName: 'testHtml Name',  // 应用名称
          appVersion: 'v0.0.1', // 应用版本号
        },
      });
      console.log('init dc', dc);
      // 初始化DC客户端，连接区块链和存储节点
      await dc.init();
    };
    const login = async () => {
      if(dc && dc.auth) {
        const res = await dc.auth.accountLogin('a', 'aaaa1111.', '000000');
        console.log('login res', res);
      }
    }

    // 对话列表
    const aiChatListSchema = {
      type: 'object',
      properties: {
        _id: { type: 'string' },
        title: { type: 'string' },
        create_time: { type: 'number' },
        modify_time: { type: 'number' }
      },
      required: ["_id"],
      additionalProperties: false,
    };
    const aiChatListCollection =  {
      name: 'ai_chat_list',
      schema: aiChatListSchema,
    }
    // 数据库表结构信息
    const dbCollections = [
      // 对话列表
      aiChatListCollection,
    ];
    const accountLoginWithWallet = async () => {
      if(dc && dc.auth) {
        const res = await dc.auth.accountLoginWithWallet();
        console.log('accountLoginWithWallet res', res);
      }
    }

    let threadId = '';
    const initDB = async () => {
      if(dc && dc.db) {
          const res = await dc.initUserDB(dbCollections,true);
          console.log('initUserDB res', res);
          threadId = res[0].id;
          console.log('initUserDB threadId', threadId);
      }
    };

    const insertDB = async () => {
      if (!dc) {
        console.error("dc not init");
        return;
      }
      const instance = {
        title: "person",
        create_time: Date.now(),
        modify_time: Date.now(),
      };
      const jsonInstance = JSON.stringify(instance); // jsonInstance
      const res = await dc.db.create(threadId, "ai_chat_list", jsonInstance);
      console.log("==========db create return", res);
    }

    const findDB = async () => {
      if (!dc) {
        console.error("dc not init");
        return;
      }
      const condition = `{}`
      const res = await dc.dbManager.find(threadId, "ai_chat_list", condition);
      console.log("==========db find return", res);
    }

    let fileCID = '';
    const uploadFile = async () => {
      if (!dc) {
        console.error("dc not init");
        return;
      }
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files?.[0];
      if (!file) {
        console.error("file not found");
        return;
      }
      const res = await dc.file.addFile(file, "blgxhdql744v247fn53adtdjdji5dp7msui5tc24uzvjtxlr4edyq", onUpdateTransmitSize);
      console.log("==========uploadFile", res);
      fileCID = res[0];
    }
    const onUpdateTransmitSize = (status, size) => {
      console.log("==========onUpdateTransmitSize", status, size);
    }


    const getFile = async () => {
      const fileContent = await dc.file.getFile(fileCID, "blgxhdql744v247fn53adtdjdji5dp7msui5tc24uzvjtxlr4edyq");
      console.log("==========getFile fileContent", fileContent);
      if (fileContent) {
        const heifIdentifiers = [
          'ftypheic', 'ftypheix', 'ftyphevc', 'ftyphevx',
          'ftypmif1', 'ftypmsf1'
        ];
        var bytes = new Uint8Array(fileContent);
        const headerString = String.fromCharCode.apply(null, Array.from(bytes.slice(4, 12)));
        const isHEIC = heifIdentifiers.some((identifier) => headerString.includes(identifier));
        console.log("isHEIC", isHEIC);
        let blob = new Blob([bytes], { type: "image/jpeg" });
        if (isHEIC) {
          const heicBlob = await heic2any({
            blob: new Blob([bytes], { type: "image/heic" }),
            toType: "image/jpeg",
          })
          blob = Array.isArray(heicBlob) ? heicBlob[0] : heicBlob;
        }
        var blobUrl = URL.createObjectURL(blob);
        const img = document.getElementById('previewImage');
        if (img) {
          img.src = blobUrl;
        }
      }
    }

  </script>
</head>
<body>
  <h1>测试DCAPI</h1>
  <button onclick="init()">init</button>
  <br>
  <br>
  <button onclick="login()">login</button>
  <br>
  <br>
  <button onclick="accountLoginWithWallet()">accountLoginWithWallet</button>
  <br>
  <br>
  <button onclick="initDB()">initDB</button>
  <br>
  <br>
  <button onclick="insertDB()">insertDB</button>
  <br>
  <br>
  <button onclick="findDB()">findDB</button>
  <br>
  <br>
  <input type="file" id="fileInput" @change="uploadFile" />
  <button onclick="uploadFile()">uploadFile</button>
  <br>
  <br>
  <button onclick="getFile()">getFile</button>
  <img id="previewImage" alt="Preview" width="300">
</body>
</html>